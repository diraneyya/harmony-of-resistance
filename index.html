<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resistance Through Harmony</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow-x: hidden;
            padding: 20px 0;
        }

        .container {
            max-width: 1200px;
            width: 95%;
            text-align: center;
            padding: 20px;
        }

        .title {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 600;
            margin-bottom: 20px;
            color: #ffffff;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            font-weight: 400;
            margin-bottom: 40px;
            color: #cccccc;
            line-height: 1.7;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto 30px auto;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        video {
            width: 100%;
            height: auto;
            display: block;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 40px 0;
            flex-wrap: wrap;
            padding: 0 20px;
        }

        .drone-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            min-width: min(350px, 90vw);
            width: 100%;
            max-width: 400px;
        }

        .control-label {
            font-size: 1.2em;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .volume-label {
            font-size: 0.9em;
            color: #cccccc;
            min-width: 30px;
            text-align: center;
        }

        .volume-slider {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: #333;
            outline: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        .volume-slider.active {
            background: linear-gradient(to right, #333 0%, #ff4444 100%);
        }

        .volume-slider.active::-webkit-slider-thumb {
            background: #ff4444;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
        }

        .volume-slider.active::-moz-range-thumb {
            background: #ff4444;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
        }

        .mobile-toggle {
            display: none;
            width: 80px;
            height: 40px;
            background: #333;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #555;
        }

        .mobile-toggle.active {
            background: linear-gradient(135deg, #ff9500, #ff6500);
            border-color: #ff9500;
            box-shadow: 0 0 15px rgba(255, 149, 0, 0.3);
        }

        .mobile-toggle-knob {
            width: 32px;
            height: 32px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .mobile-toggle.active .mobile-toggle-knob {
            transform: translateX(40px);
            background: #fff;
        }

        .toggle-labels {
            display: none;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-top: 10px;
        }

        .toggle-label {
            font-size: 0.8rem;
            color: #cccccc;
        }

        .toggle-label.active {
            color: #ff9500;
            font-weight: 500;
        }

        .volume-display {
            display: none;
            font-size: 1em;
            color: #ffffff;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        .tip-box {
            max-width: 600px;
            margin: 50px auto 30px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .tip-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .tip-content {
            flex: 1;
        }

        .tip-content p {
            margin: 0 0 12px 0;
            line-height: 1.6;
            color: #dddddd;
            font-size: 0.95rem;
        }

        .tip-content p:last-child {
            margin-bottom: 0;
        }

        .tip-shortcuts {
            font-size: 0.85rem !important;
            color: #aaaaaa !important;
            margin-top: 15px !important;
        }

        kbd {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.8rem;
            font-family: 'Inter', monospace;
            color: #ffffff;
        }
        

        .status {
            margin-top: 20px;
            font-size: 1.1em;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .status.without-drone {
            background: rgba(68, 255, 68, 0.2);
            border: 1px solid #44ff44;
            color: #99ff99;
        }

        .status.with-drone {
            border: 1px solid;
            transition: all 0.3s ease;
        }

        /* Mobile Bottom Bar Styles */
        .mobile-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 26, 0.98);
            background-image: url('drone.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: 50% 35%;
            background-blend-mode: overlay;
            backdrop-filter: blur(15px);
            padding: 12px 20px;
            z-index: 1000;
            border-top: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 -5px 25px rgba(0,0,0,0.4);
        }
        
        .mobile-bottom-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('drone.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: 50% 35%;
            opacity: 0.15;
            pointer-events: none;
            z-index: -1;
        }

        .bottom-bar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 500px;
            margin: 0 auto;
        }

        .mobile-play-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .mobile-play-button:hover {
            transform: scale(1.05);
        }

        .mobile-play-button.playing {
            background: linear-gradient(135deg, #ff9500, #ff6500);
        }

        .play-icon {
            width: 0;
            height: 0;
            border-left: 12px solid #333;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            margin-left: 3px;
            transition: all 0.3s ease;
        }

        .mobile-play-button.playing .play-icon {
            border: none;
            width: 12px;
            height: 16px;
            background: linear-gradient(to right, #fff 0%, #fff 35%, transparent 35%, transparent 65%, #fff 65%, #fff 100%);
            margin-left: 0;
        }

        .bottom-bar-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bottom-bar-label {
            color: white;
            font-size: 1rem;
            font-weight: 500;
        }

        .mobile-toggle-bottom {
            width: 60px;
            height: 30px;
            background: #333;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mobile-toggle-bottom.active {
            background: linear-gradient(135deg, #ff9500, #ff6500);
        }

        .mobile-toggle-bottom .mobile-toggle-knob {
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .mobile-toggle-bottom.active .mobile-toggle-knob {
            transform: translateX(30px);
        }

        @media (min-width: 1025px) {
            body {
                height: 100vh;
                overflow: hidden;
            }
            
            .mobile-toggle, .toggle-labels {
                display: none;
            }
            .mobile-bottom-bar {
                display: none !important;
            }
            .mobile-tip {
                display: none !important;
            }
            .mobile-header {
                display: none !important;
            }
            
            .container {
                max-width: 1400px;
                display: flex;
                gap: 40px;
                align-items: flex-start;
                text-align: left;
                height: 100vh;
                overflow: hidden;
            }
            
            .content-left {
                flex: 1;
                min-width: 0;
                height: 100vh;
                overflow-y: auto;
                padding-right: 10px;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                padding-top: 20px;
            }
            
            .title {
                font-size: clamp(1.5rem, 3vw, 2.5rem);
                margin-bottom: 15px;
            }
            
            .subtitle {
                font-size: clamp(0.9rem, 1.2vw, 1rem);
                margin-bottom: 25px;
                line-height: 1.5;
            }
            
            .tip-box {
                margin: 20px 0;
                display: flex;
                align-items: flex-start;
                max-width: none;
                padding: 15px;
                flex-shrink: 0;
            }
            
            .tip-content p {
                font-size: clamp(0.8rem, 1vw, 0.95rem);
                line-height: 1.5;
            }
            
            .tip-shortcuts {
                font-size: clamp(0.7rem, 0.9vw, 0.85rem) !important;
            }
            
            .control-label {
                font-size: clamp(0.9rem, 1.1vw, 1.1rem);
            }
            
            .status {
                font-size: clamp(0.9rem, 1vw, 1rem);
                padding: 8px 16px;
                margin: 15px 0;
            }
            
            .desktop-play-button {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: linear-gradient(135deg, #ffffff, #e0e0e0);
                border: none;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                box-shadow: 0 6px 20px rgba(0,0,0,0.3);
                margin: 20px auto;
                align-self: center;
            }
            
            .desktop-play-button:hover {
                transform: scale(1.05);
                box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            }
            
            .desktop-play-button.playing {
                background: linear-gradient(135deg, #ff9500, #ff6500);
            }
            
            .desktop-play-icon {
                width: 0;
                height: 0;
                border-left: 16px solid #333;
                border-top: 12px solid transparent;
                border-bottom: 12px solid transparent;
                margin-left: 4px;
                transition: all 0.3s ease;
            }
            
            .desktop-play-button.playing .desktop-play-icon {
                border: none;
                width: 16px;
                height: 20px;
                background: linear-gradient(to right, #fff 0%, #fff 35%, transparent 35%, transparent 65%, #fff 65%, #fff 100%);
                margin-left: 0;
            }
            
            .content-right {
                width: 500px;
                flex-shrink: 0;
                height: 100vh;
                display: flex;
                align-items: center;
            }
            
            .video-container {
                width: 100%;
                height: auto;
            }
            
            .video-container video {
                width: 100%;
                height: auto;
                max-height: 90vh;
                object-fit: contain;
            }
            
            .status {
                text-align: center;
            }
        }

        @media (max-width: 1024px) {
            body {
                padding: 0;
                height: 100vh;
                overflow: hidden;
            }
            
            /* Full-height mobile layout */
            .container {
                height: 100vh;
                display: flex;
                flex-direction: column;
                padding: 0;
            }
            
            /* Pinned mobile header */
            .mobile-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: rgba(26, 26, 26, 0.9);
                backdrop-filter: blur(15px);
                z-index: 999;
                padding: 15px 20px;
                transition: all 0.4s ease;
                cursor: pointer;
            }
            
            .mobile-header:hover {
                background: rgba(26, 26, 26, 0.95);
                padding: 20px 20px 30px 20px;
                box-shadow: 0 0 30px rgba(0,0,0,0.6);
            }
            
            .mobile-header .title {
                font-size: 1.4rem;
                margin: 0;
                transition: all 0.4s ease;
                color: #ffffff;
            }
            
            .mobile-header .subtitle {
                font-size: 0.85rem;
                margin: 10px 0 0 0;
                max-height: 0;
                overflow: hidden;
                opacity: 0;
                transition: all 0.4s ease;
                line-height: 1.4;
                color: #cccccc;
            }
            
            .mobile-header:hover .subtitle {
                max-height: 150px;
                opacity: 1;
            }
            
            /* Reposition existing video container for mobile full-height */
            .video-container {
                flex: 1;
                display: flex;
                align-items: flex-start;
                justify-content: center;
                background: #000;
                position: relative;
                margin: 0;
                border-radius: 0;
                max-width: none;
                box-shadow: none;
            }
            
            .video-container video {
                width: 100%;
                height: 85%;
                object-fit: contain;
            }
            
            /* Hide desktop elements on mobile */
            .mobile-toggle, .toggle-labels {
                display: none !important;
            }
            
            .status {
                display: none !important;
            }
            
            .volume-label {
                display: none !important;
            }
            
            .volume-display {
                display: none !important;
            }
            
            .tip-box {
                display: none !important;
            }
            
            .control-label {
                display: none !important;
            }
            
            .desktop-play-button {
                display: none !important;
            }
            
            /* Hide desktop left content on mobile, show video container */
            .content-left {
                display: none !important;
            }
            
            .content-right {
                flex: 1;
                width: 100%;
                height: calc(100vh - 240px);
                margin-top: 80px;
                display: flex !important;
                align-items: stretch;
            }
            
            .container {
                width: 100%;
                padding: 0;
            }
            
            .controls {
                gap: 25px;
                margin: 30px 0;
                padding: 0 10px;
            }
            
            .drone-control {
                min-width: 100%;
                gap: 15px;
            }
            
            /* Hide slider on mobile, show toggle */
            .slider-container {
                display: none;
            }
            
            .mobile-toggle {
                display: block;
                margin: 0 auto;
            }
            
            .toggle-labels {
                display: flex;
            }
            
            .volume-label {
                font-size: 0.8rem;
                min-width: 25px;
            }
            
            .tip-box {
                flex-direction: column;
                text-align: center;
                padding: 18px;
                margin: 40px auto 25px;
                gap: 12px;
            }
            
            .tip-icon {
                margin-top: 0;
                align-self: center;
            }
            
            .status {
                font-size: 1rem;
                padding: 12px 18px;
                margin: 15px 10px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .video-container {
                border-radius: 8px;
            }
            
            .controls {
                gap: 20px;
                margin: 25px 0;
            }
            
            .tip-box {
                padding: 15px;
                margin: 30px auto 20px;
            }
            
            .tip-content p {
                font-size: 0.9rem;
            }
            
            .tip-shortcuts {
                font-size: 0.8rem !important;
            }
        }

        .audio-visualizer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, rgba(255,68,68,0.1));
            display: none;
        }

        .audio-visualizer.active {
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #ff4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 15px;
            text-align: center;
        }

        .loading-subtext {
            color: #cccccc;
            font-size: 0.9rem;
            text-align: center;
            max-width: 400px;
            line-height: 1.5;
        }

        .loading-progress {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ff6666);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        @media (max-width: 480px) {
            .loading-spinner {
                width: 50px;
                height: 50px;
                margin-bottom: 25px;
            }
            
            .loading-text {
                font-size: 1.1rem;
            }
            
            .loading-progress {
                width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Resistance</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
        <div class="loading-subtext">Preparing audio and video files...</div>
    </div>

    <!-- Mobile Sticky Header -->
    <div class="mobile-header" id="mobileHeader">
        <h1 class="title">Resistance Through Harmony</h1>
        <p class="subtitle">
            Living under constant surveillance, where the hum of drones becomes the soundtrack to daily life, 
            Ahmed Muin from <i>Gaza Birds Singing</i> in Gaza discovered something profound: by singing in harmony with the drone's frequency, 
            the oppressive sound transforms into an instrument of resistance.
        </p>
    </div>

    <div class="container" id="mainContainer">
        <!-- Desktop Layout -->
        <div class="content-left">
            <h1 class="title">Resistance Through Harmony</h1>
            <p class="subtitle">
                Living under constant surveillance, where the hum of drones becomes the soundtrack to daily life, 
                Ahmed Muin from <i>Gaza Birds Singing</i> in Gaza discovered something profound: by singing in harmony with the drone's frequency, 
                the oppressive sound transforms into an instrument of resistance.
            </p>

            <button class="desktop-play-button" id="desktopPlayButton">
                <div class="desktop-play-icon"></div>
            </button>

            <div class="status" id="statusText">Adjust the drone volume slider below to add/remove drone sound</div>
            
            <div class="controls">
                <div class="drone-control">
                    <div class="control-label">Drone Volume</div>
                    <div class="slider-container">
                        <span class="volume-label">Off</span>
                        <input type="range" id="droneSlider" min="0" max="100" value="0" class="volume-slider">
                        <span class="volume-label">Max</span>
                    </div>
                    
                    <!-- Mobile Toggle (hidden on desktop) -->
                    <div class="mobile-toggle" id="mobileToggle">
                        <div class="mobile-toggle-knob"></div>
                    </div>
                    <div class="toggle-labels">
                        <span class="toggle-label" id="toggleLabelOff">Off</span>
                        <span class="toggle-label" id="toggleLabelOn">On</span>
                    </div>
                    
                    <div class="volume-display" id="volumeDisplay">0%</div>
                </div>
            </div>

            <div class="tip-box">
                <div class="tip-icon">💡</div>
                <div class="tip-content">
                    <p>Use the volume slider above to control the drone audio layer. By changing the volume you can more clearly understand how the artist harmonized with the oppressive surveillance soundtrack.</p>
                    <p class="tip-shortcuts">Keyboard shortcuts (when on desktop): <kbd>Space</kbd> to play/pause video • <kbd>D</kbd> to toggle drone volume</p>
                </div>
            </div>
        </div>

        <div class="content-right">
            <div class="video-container">
                <video id="videoPlayer" controls playsinline webkit-playsinline>
                    <source src="song_cleaned.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <audio id="droneAudio" loop preload="auto">
                    <source src="zannana_improved_exact.mp3" type="audio/mpeg">
                </audio>
                <div class="audio-visualizer"></div>
            </div>
            
            <!-- Tip box shows under video on mobile -->
            <div class="tip-box mobile-tip">
                <div class="tip-icon">💡</div>
                <div class="tip-content">
                    <p>Use the toggle at the bottom to add/remove drone sound and experience the artist's resistance.</p>
                    <p class="tip-shortcuts">Tap the toggle to switch between modes</p>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // Loading system
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingProgressBar = document.getElementById('loadingProgressBar');
        const loadingSubtext = document.querySelector('.loading-subtext');
        
        let loadingProgress = {
            video: false,
            audio: false,
            videoBuffered: false,
            progress: 0
        };
        
        function updateLoadingProgress() {
            let completed = 0;
            if (loadingProgress.video) completed++;
            if (loadingProgress.audio) completed++;
            if (loadingProgress.videoBuffered) completed++;
            
            const percentage = (completed / 3) * 100;
            loadingProgressBar.style.width = percentage + '%';
            
            // Update loading text based on progress
            if (loadingProgress.video && loadingProgress.audio && !loadingProgress.videoBuffered) {
                loadingSubtext.textContent = 'Buffering video... (33MB)';
            } else if (loadingProgress.video && loadingProgress.audio && loadingProgress.videoBuffered) {
                loadingSubtext.textContent = 'Ready to experience resistance through harmony';
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    // Remove the overlay completely after transition
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500);
                }, 500);
            }
        }
        
        async function setupMediaLoading() {
            const videoPlayer = document.getElementById('videoPlayer');
            const droneAudio = document.getElementById('droneAudio');
            
            // Detect bandwidth and set appropriate video source
            if (adaptiveVideoEnabled) {
                loadingSubtext.textContent = 'Detecting connection speed...';
                detectedBandwidth = await detectBandwidth();
                const videoSource = getVideoSource(detectedBandwidth);
                
                // Update video source
                const sourceElement = videoPlayer.querySelector('source');
                if (sourceElement) {
                    sourceElement.src = videoSource;
                    loadingSubtext.textContent = `Loading video (${detectedBandwidth} quality)...`;
                }
            }
            
            // Video metadata loaded
            videoPlayer.addEventListener('loadeddata', () => {
                loadingProgress.video = true;
                updateLoadingProgress();
            });
            
            // Video fully buffered and ready to play without interruption
            videoPlayer.addEventListener('canplaythrough', () => {
                loadingProgress.videoBuffered = true;
                updateLoadingProgress();
            });
            
            videoPlayer.addEventListener('error', () => {
                loadingSubtext.textContent = 'Error loading video file';
                loadingProgress.video = true;
                loadingProgress.videoBuffered = true;
                updateLoadingProgress();
            });
            
            // Audio loading
            droneAudio.addEventListener('canplaythrough', () => {
                loadingProgress.audio = true;
                updateLoadingProgress();
            });
            
            droneAudio.addEventListener('error', () => {
                loadingSubtext.textContent = 'Error loading drone audio file';
                loadingProgress.audio = true;
                updateLoadingProgress();
            });
            
            // Force load the media
            videoPlayer.load();
            droneAudio.load();
            
            // Extended fallback timeout for large video
            const timeoutDuration = detectedBandwidth === 'ultra_low' ? 60000 : 30000;
            setTimeout(() => {
                if (!loadingProgress.video || !loadingProgress.audio || !loadingProgress.videoBuffered) {
                    loadingProgress.video = true;
                    loadingProgress.audio = true;
                    loadingProgress.videoBuffered = true;
                    loadingSubtext.textContent = 'Loading timeout - proceeding anyway';
                    updateLoadingProgress();
                }
            }, timeoutDuration);
        }
        
        // Initialize loading system
        setupMediaLoading();

        const droneSlider = document.getElementById('droneSlider');
        const videoPlayer = document.getElementById('videoPlayer');
        const droneAudio = document.getElementById('droneAudio');
        const statusText = document.getElementById('statusText');
        const volumeDisplay = document.getElementById('volumeDisplay');
        const audioVisualizer = document.querySelector('.audio-visualizer');
        
        // Mobile toggle elements
        const mobileToggle = document.getElementById('mobileToggle');
        const toggleLabelOff = document.getElementById('toggleLabelOff');
        const toggleLabelOn = document.getElementById('toggleLabelOn');
        
        // Mobile bottom bar elements (will be set after DOM loads)
        let mobilePlayButton;
        let mobileToggleBottom;
        
        let currentVolume = 0;
        let audioContext;
        let videoSource, droneSource, gainNode;
        let isAudioSetup = false;
        
        // Adaptive video quality based on bandwidth detection
        let detectedBandwidth = 'unknown';
        let adaptiveVideoEnabled = true;
        
        // Bandwidth detection using network connection API and fallback test
        async function detectBandwidth() {
            try {
                // Try modern Network Information API first
                if ('connection' in navigator) {
                    const connection = navigator.connection;
                    const effectiveType = connection.effectiveType;
                    
                    console.log(`Network type detected: ${effectiveType}`);
                    
                    // Map connection types to our quality levels
                    const typeMap = {
                        'slow-2g': 'ultra_low',
                        '2g': 'ultra_low', 
                        '3g': 'low',
                        '4g': 'high'
                    };
                    
                    if (typeMap[effectiveType]) {
                        return typeMap[effectiveType];
                    }
                }
                
                // Fallback: Test download speed
                const startTime = Date.now();
                const response = await fetch('song_cleaned.mp4', { 
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const endTime = Date.now();
                    const responseTime = endTime - startTime;
                    
                    console.log(`Connection test: ${responseTime}ms response time`);
                    
                    // Categorize based on response time
                    if (responseTime > 2000) {
                        return 'ultra_low'; // Very slow connection
                    } else if (responseTime > 1000) {
                        return 'low'; // Moderate connection
                    } else {
                        return 'high'; // Fast connection
                    }
                }
                
            } catch (error) {
                console.log('Bandwidth detection failed:', error);
            }
            
            // Default to high quality if all tests fail
            return 'high';
        }
        
        // Select appropriate video source based on bandwidth
        function getVideoSource(bandwidth) {
            const sources = {
                ultra_low: 'song_cleaned_ultra_low.mp4', // 3.2MB, 360p
                low: 'song_cleaned_low.mp4',             // 7.3MB, 480p  
                high: 'song_cleaned.mp4'                 // 24MB, 720p
            };
            
            console.log(`Selected video quality: ${bandwidth} (${sources[bandwidth]})`);
            return sources[bandwidth] || sources.high;
        }
        
        // Initialize Web Audio API for seamless audio mixing
        function setupAudioContext() {
            if (isAudioSetup) return;
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create audio sources
                videoSource = audioContext.createMediaElementSource(videoPlayer);
                droneSource = audioContext.createMediaElementSource(droneAudio);
                
                // Create gain node for drone volume control
                gainNode = audioContext.createGain();
                gainNode.gain.value = 0; // Start with drone muted
                
                // Connect audio graph: video -> output, drone -> gain -> output
                videoSource.connect(audioContext.destination);
                droneSource.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                isAudioSetup = true;
                console.log('Audio context initialized successfully');
            } catch (error) {
                console.error('Web Audio API not supported:', error);
                // Fallback to simple play/pause method
                setupFallbackAudio();
            }
        }
        
        function setupFallbackAudio() {
            // Simple fallback for browsers that don't support Web Audio API
            droneAudio.volume = 0;
            isAudioSetup = true;
        }
        
        function setDroneVolume(volume) {
            // Deprecated: Convert 0-100 to 0-0.2 (50% max)
            // ffmpeg -i zannana_improved_exact.mp3 -filter:a "volume=0.15" \
            //           zannana_improved_exact_20percent.mp3
            const normalizedVolume = (volume / 100) * 0.50; 
            
            if (audioContext && gainNode) {
                // Smooth transition using Web Audio API
                const fadeTime = 0.05; // 50ms fade
                const currentTime = audioContext.currentTime;
                gainNode.gain.setValueAtTime(gainNode.gain.value, currentTime);
                gainNode.gain.linearRampToValueAtTime(normalizedVolume, currentTime + fadeTime);
            } else {
                // Fallback method
                droneAudio.volume = normalizedVolume;
            }
            
            // Handle drone playback based on volume and video state
            if (volume > 0) {
                if (!videoPlayer.paused) {
                    droneAudio.currentTime = videoPlayer.currentTime;
                    droneAudio.play().catch(e => console.log('Drone audio play failed:', e));
                }
            } else {
                droneAudio.pause();
            }
        }
        
        function syncDroneWithVideo() {
            // Keep drone audio in sync with video
            if (Math.abs(droneAudio.currentTime - videoPlayer.currentTime) > 0.2) {
                droneAudio.currentTime = videoPlayer.currentTime;
            }
        }
        
        function updateUI(volume) {
            volumeDisplay.textContent = volume + '%';
            
            if (volume > 0) {
                droneSlider.classList.add('active');
                audioVisualizer.classList.add('active');
                statusText.textContent = `Playing with drone sound (${volume}%)`;
                statusText.className = 'status with-drone';
                
                // Calculate gradient color from yellow to red based on volume (0-100%)
                const ratio = Math.min(volume / 100, 1); // Ensure ratio doesn't exceed 1
                
                // Yellow to Orange gradient: Yellow (255,255,0) to Orange (255,165,0)
                const red = 255;
                const green = Math.round(255 * (1 - ratio * 0.35)); // Decreases from 255 to 165 (orange)
                const blue = 0;
                
                // Apply the gradient colors
                const bgColor = `rgba(${red}, ${green}, ${blue}, 0.2)`;
                const borderColor = `rgb(${red}, ${green}, ${blue})`;
                const textColor = `rgb(${Math.min(255, red + 50)}, ${Math.min(255, green + 50)}, ${Math.min(255, blue + 50)})`;
                
                statusText.style.background = bgColor;
                statusText.style.borderColor = borderColor;
                statusText.style.color = textColor;
            } else {
                droneSlider.classList.remove('active');
                audioVisualizer.classList.remove('active');
                statusText.textContent = 'Playing without drone\'s sound';
                statusText.className = 'status without-drone';
                
                // Reset inline styles for without-drone state
                statusText.style.background = '';
                statusText.style.borderColor = '';
                statusText.style.color = '';
            }
        }
        
        // Mobile toggle functionality
        function updateMobileToggle(volume) {
            const isActive = volume > 0;
            mobileToggle.classList.toggle('active', isActive);
            toggleLabelOff.classList.toggle('active', !isActive);
            toggleLabelOn.classList.toggle('active', isActive);
        }
        
        function handleMobileToggle() {
            const newVolume = currentVolume > 0 ? 0 : 50;
            currentVolume = newVolume;
            droneSlider.value = newVolume; // Keep slider in sync for internal logic
            
            // Setup audio context on first user interaction
            if (!isAudioSetup) {
                setupAudioContext();
            }
            
            // Resume audio context if suspended
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            setDroneVolume(currentVolume);
            updateUI(currentVolume);
            updateMobileToggle(currentVolume);
        }
        
        // Event handlers
        droneSlider.addEventListener('input', function() {
            currentVolume = parseInt(this.value);
            
            // Setup audio context on first user interaction (required by browsers)
            if (!isAudioSetup) {
                setupAudioContext();
            }
            
            // Resume audio context if suspended (required by some browsers)
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            setDroneVolume(currentVolume);
            updateUI(currentVolume);
            updateMobileToggle(currentVolume);
        });
        
        // Mobile toggle event handler
        mobileToggle.addEventListener('click', handleMobileToggle);
        
        // Mobile play button functionality
        function handleMobilePlayButton() {
            console.log('Mobile play button clicked');
            console.log('Video paused:', videoPlayer.paused);
            if (videoPlayer.paused) {
                videoPlayer.play().catch(e => console.log('Play failed:', e));
            } else {
                videoPlayer.pause();
            }
        }
        
        // Mobile toggle bottom functionality  
        function handleMobileToggleBottom() {
            const newVolume = currentVolume > 0 ? 0 : 50;
            currentVolume = newVolume;
            
            // Setup audio context on first interaction
            if (!isAudioSetup) {
                setupAudioContext();
            }
            
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            setDroneVolume(currentVolume);
            updateUI(currentVolume);
            updateMobileToggle(currentVolume);
            updateMobileBottomToggle(currentVolume);
        }
        
        // Update mobile bottom toggle visual state
        function updateMobileBottomToggle(volume) {
            if (!mobileToggleBottom) return;
            mobileToggleBottom.classList.toggle('active', volume > 0);
        }
        
        // Update mobile play button visual state
        function updateMobilePlayButton() {
            if (!mobilePlayButton || !videoPlayer) return;
            const isPlaying = !videoPlayer.paused;
            mobilePlayButton.classList.toggle('playing', isPlaying);
        }
        
        // Setup mobile controls after DOM loads
        function setupMobileControls() {
            mobilePlayButton = document.getElementById('mobilePlayButton');
            mobileToggleBottom = document.getElementById('mobileToggleBottom');
            
            if (mobilePlayButton) {
                console.log('Mobile play button found, adding listener');
                mobilePlayButton.addEventListener('click', handleMobilePlayButton);
            } else {
                console.log('Mobile play button not found');
            }
            
            if (mobileToggleBottom) {
                console.log('Mobile toggle bottom found, adding listener');
                mobileToggleBottom.addEventListener('click', handleMobileToggleBottom);
            } else {
                console.log('Mobile toggle bottom not found');
            }
            
            // Initialize states
            updateMobileBottomToggle(0);
            updateMobilePlayButton();
            
            // Update play button when video state changes
            if (videoPlayer) {
                videoPlayer.addEventListener('play', updateMobilePlayButton);
                videoPlayer.addEventListener('pause', updateMobilePlayButton);
                videoPlayer.addEventListener('ended', updateMobilePlayButton);
            }
        }
        
        // Call setup after page loads
        document.addEventListener('DOMContentLoaded', setupMobileControls);
        
        
        // Sync drone audio with video playback
        videoPlayer.addEventListener('play', function() {
            droneAudio.currentTime = videoPlayer.currentTime;
            if (currentVolume > 0) {
                droneAudio.play().catch(e => console.log('Drone audio play failed:', e));
            }
        });
        
        videoPlayer.addEventListener('pause', function() {
            droneAudio.pause();
        });
        
        videoPlayer.addEventListener('seeked', function() {
            droneAudio.currentTime = videoPlayer.currentTime;
            if (!videoPlayer.paused && currentVolume > 0) {
                droneAudio.play().catch(e => console.log('Drone audio play failed:', e));
            }
        });
        
        // Periodic sync to prevent drift
        setInterval(() => {
            if (!videoPlayer.paused && isDroneActive) {
                syncDroneWithVideo();
            }
        }, 1000);
        
        // Initialize
        updateUI(0);
        updateMobileToggle(0);
        
        // Desktop play button functionality
        function setupDesktopPlayButton() {
            const desktopPlayButton = document.getElementById('desktopPlayButton');
            
            if (!desktopPlayButton) return;
            
            desktopPlayButton.addEventListener('click', function() {
                if (videoPlayer.paused) {
                    videoPlayer.play().catch(e => console.log('Desktop play failed:', e));
                } else {
                    videoPlayer.pause();
                }
            });
            
            // Update desktop play button visual state
            function updateDesktopPlayButton() {
                if (!desktopPlayButton || !videoPlayer) return;
                const isPlaying = !videoPlayer.paused;
                desktopPlayButton.classList.toggle('playing', isPlaying);
            }
            
            // Update button state when video state changes
            videoPlayer.addEventListener('play', updateDesktopPlayButton);
            videoPlayer.addEventListener('pause', updateDesktopPlayButton);
            videoPlayer.addEventListener('ended', updateDesktopPlayButton);
            
            // Initialize state
            updateDesktopPlayButton();
        }
        
        // Initialize desktop play button
        document.addEventListener('DOMContentLoaded', setupDesktopPlayButton);
        
        // Add keyboard shortcut
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                if (videoPlayer.paused) {
                    videoPlayer.play();
                } else {
                    videoPlayer.pause();
                }
            } else if (e.code === 'KeyD') {
                // Toggle between 0 and 100% volume with D key
                const newVolume = currentVolume > 0 ? 0 : 100;
                currentVolume = newVolume;
                droneSlider.value = newVolume;
                
                // Setup audio context on first interaction if needed
                if (!isAudioSetup) {
                    setupAudioContext();
                }
                
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                setDroneVolume(currentVolume);
                updateUI(currentVolume);
                updateMobileToggle(currentVolume);
                
                // Also update mobile bottom toggle if it exists
                const mobileToggleBottom = document.getElementById('mobileToggleBottom');
                if (mobileToggleBottom) {
                    mobileToggleBottom.classList.toggle('active', currentVolume > 0);
                }
            }
        });
        
        // Initialize with proper fallback setup
        if (!audioContext) {
            setupFallbackAudio();
        }
    </script>

    <!-- Mobile Bottom Control Bar -->
    <div class="mobile-bottom-bar" id="mobileBottomBar">
        <div class="bottom-bar-content">
            <button class="mobile-play-button" id="mobilePlayButton">
                <div class="play-icon"></div>
            </button>
            <div class="bottom-bar-controls">
                <div class="bottom-bar-label">Drone Sound</div>
                <div class="mobile-toggle-bottom" id="mobileToggleBottom">
                    <div class="mobile-toggle-knob"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>